package com.shafaei.imageFinder.businessLogic.network.service

import com.google.gson.Gson
import com.shafaei.imageFinder.businessLogic.network.RetrofitUtil
import io.reactivex.Scheduler
import io.reactivex.schedulers.Schedulers
import okhttp3.mockwebserver.MockResponse
import okhttp3.mockwebserver.MockWebServer
import org.junit.jupiter.api.*
import org.junit.jupiter.api.TestInstance.Lifecycle
import retrofit2.Retrofit
import retrofit2.Retrofit.Builder
import retrofit2.adapter.rxjava2.RxJava2CallAdapterFactory
import retrofit2.converter.gson.GsonConverterFactory


@TestInstance(Lifecycle.PER_CLASS)
internal class ImageServiceTest {
  private val mockWebServer = MockWebServer()
  private lateinit var retrofit: Retrofit
  private lateinit var scheduler: Scheduler

  @BeforeAll
  fun setUp() {
    scheduler = Schedulers.newThread()

    retrofit = Builder()
       .baseUrl(mockWebServer.url("").toString())
       .addConverterFactory(GsonConverterFactory.create(Gson()))
       .addCallAdapterFactory(RxJava2CallAdapterFactory.create())
       .build()
  }

  @Test
  fun test_APIKEY_ReturnTrue() {
    val mockResponseBody = "[ERROR 400] Invalid or missing API key (https://pixabay.com/api/docs/)."
    mockWebServer.enqueue(MockResponse().setBody(mockResponseBody).setResponseCode(400))

    val imageService = retrofit.create(ImageService::class.java)
    val observer = imageService.searchImages(query = "flower", page = "1")
       .subscribeOn(scheduler)
       .blockingGet()

    Assertions.assertTrue(RetrofitUtil.hasError(observer)) { "Response Has Error" }
    Assertions.assertTrue(observer.response()!!.errorBody()!!.string().startsWith("[ERROR 400] Invalid or missing API key"))
  }

  @Test
  fun search_flower_returnValidData() {
    val mockResponseBody = "{\"total\":218948,\"totalHits\":500,\"hits\":[{\"id\":324175,\"pageURL\":\"https://pixabay.com/photos/pink-cherry-blossoms-flowers-branch-324175/\",\"type\":\"photo\",\"tags\":\"pink, cherry blossoms, flowers\",\"previewURL\":\"https://cdn.pixabay.com/photo/2014/04/14/20/11/pink-324175_150.jpg\",\"previewWidth\":150,\"previewHeight\":99,\"webformatURL\":\"https://pixabay.com/get/g9812c3a78193b80446d96c4b3c5bf6be4f310df3a11af91acc4c6a203ac588a7100aad8421c896210931007c3f336811_640.jpg\",\"webformatWidth\":640,\"webformatHeight\":426,\"largeImageURL\":\"https://pixabay.com/get/g9121b50698db32738514b2de40e4552f926279624f698f7d09c4d53cdd17f4579f81d1a60f7c72133572045ef585436aa97f733a3ea3bbbd82b2f30b175c54cc_1280.jpg\",\"imageWidth\":6000,\"imageHeight\":4000,\"imageSize\":2613829,\"views\":2878023,\"downloads\":1388797,\"favorites\":3278,\"collections\":3278,\"likes\":4169,\"comments\":939,\"user_id\":2,\"user\":\"Hans\",\"userImageURL\":\"https://cdn.pixabay.com/user/2019/01/29/15-01-52-802_250x250.jpg\"},{\"id\":729510,\"pageURL\":\"https://pixabay.com/photos/marguerite-daisy-flower-white-729510/\",\"type\":\"photo\",\"tags\":\"marguerite, daisy, flower\",\"previewURL\":\"https://cdn.pixabay.com/photo/2015/04/19/08/32/marguerite-729510_150.jpg\",\"previewWidth\":150,\"previewHeight\":97,\"webformatURL\":\"https://pixabay.com/get/gac23db4973aabfbb4009d4aee5c3730e7a9462d3f52bee11e3c9bc64b0601852ad24b9454c0bd5e31a11a4130e68028e_640.jpg\",\"webformatWidth\":640,\"webformatHeight\":416,\"largeImageURL\":\"https://pixabay.com/get/gbb80c198bb5923da2278e1068ab3e914612a812cac80685d3d166d7772b328efc0d05f10e32c47dfca39ce823a2d4f26762bd8cbc395c927234600050736516e_1280.jpg\",\"imageWidth\":1980,\"imageHeight\":1289,\"imageSize\":307038,\"views\":811733,\"downloads\":315652,\"favorites\":1775,\"collections\":1775,\"likes\":2065,\"comments\":478,\"user_id\":909086,\"user\":\"Bessi\",\"userImageURL\":\"https://cdn.pixabay.com/user/2019/04/11/22-45-05-994_250x250.jpg\"},{\"id\":1770165,\"pageURL\":\"https://pixabay.com/illustrations/roses-collage-vintage-antique-1770165/\",\"type\":\"illustration\",\"tags\":\"roses, collage, vintage\",\"previewURL\":\"https://cdn.pixabay.com/photo/2016/10/25/22/22/roses-1770165_150.png\",\"previewWidth\":150,\"previewHeight\":120,\"webformatURL\":\"https://pixabay.com/get/g88a6957392791b5f3872eccc7b7b70d9d3620c529d09cf84d9a3c56901242799c38faf4cf033c6cb761e79a6a2b581f89a5c99da47df1a357070ce53348b8cdc_640.png\",\"webformatWidth\":640,\"webformatHeight\":512,\"largeImageURL\":\"https://pixabay.com/get/g748f5e460ac0efb9be237b62104f058b3f53c05fa93a643bcb232d25870d7764d87b22e94ec37319399c381ab97e70e3dedd9a9d14aa82f412a880a5c6ce267e_1280.png\",\"imageWidth\":3000,\"imageHeight\":2400,\"imageSize\":6369203,\"views\":466666,\"downloads\":170772,\"favorites\":2258,\"collections\":2258,\"likes\":1892,\"comments\":466,\"user_id\":462611,\"user\":\"ArtsyBee\",\"userImageURL\":\"https://cdn.pixabay.com/user/2014/10/01/08-58-08-781_250x250.png\"},{\"id\":165819,\"pageURL\":\"https://pixabay.com/photos/rose-flower-dew-dewdrops-droplets-165819/\",\"type\":\"photo\",\"tags\":\"rose, flower, dew\",\"previewURL\":\"https://cdn.pixabay.com/photo/2013/07/21/13/00/rose-165819_150.jpg\",\"previewWidth\":150,\"previewHeight\":99,\"webformatURL\":\"https://pixabay.com/get/g46e15201a05eb5570fdaf6af000c39d09dbe6568ed21a2be7112166ca45a0a127549cfc57a6235c42c45abbb245b443d_640.jpg\",\"webformatWidth\":640,\"webformatHeight\":423,\"largeImageURL\":\"https://pixabay.com/get/g6d97b3fa017c16e4d27ac75dd4eb242c0ca53c3861214c04d94d6c8d68d3f0739ffa955bb063937d7340644dbe58e2cb7b21f7a80979e683a43b3a761d60d160_1280.jpg\",\"imageWidth\":4928,\"imageHeight\":3264,\"imageSize\":4000578,\"views\":1284829,\"downloads\":346986,\"favorites\":1707,\"collections\":1707,\"likes\":2222,\"comments\":445,\"user_id\":768,\"user\":\"GLady\",\"userImageURL\":\"https://cdn.pixabay.com/user/2014/07/12/21-19-34-426_250x250.jpg\"},{\"id\":3140492,\"pageURL\":\"https://pixabay.com/photos/flower-nature-flora-petal-summer-3140492/\",\"type\":\"photo\",\"tags\":\"flower, nature, flora\",\"previewURL\":\"https://cdn.pixabay.com/photo/2018/02/08/22/27/flower-3140492_150.jpg\",\"previewWidth\":150,\"previewHeight\":100,\"webformatURL\":\"https://pixabay.com/get/g264e2da3e1e3aa0b04103343c5bc2e2893a54bf73acaf8628fc931f0a8e561200ca298d3cd2de1b5273bf0b3f78c2a7abfddff6988ffed5486d8ba29be789a3f_640.jpg\",\"webformatWidth\":640,\"webformatHeight\":427,\"largeImageURL\":\"https://pixabay.com/get/g0edf38d594a6abb85d1f2f2effca5da7f1965120e4cad73d2e29d18b2ea1a7ac7aeedba59a9ad7b57ee815d80fb39deeaa659aabb16094388103acdcfae29c27_1280.jpg\",\"imageWidth\":5689,\"imageHeight\":3803,\"imageSize\":3511611,\"views\":1625842,\"downloads\":1009240,\"favorites\":2059,\"collections\":2059,\"likes\":2119,\"comments\":245,\"user_id\":334088,\"user\":\"JillWellington\",\"userImageURL\":\"https://cdn.pixabay.com/user/2018/06/27/01-23-02-27_250x250.jpg\"},{\"id\":1205631,\"pageURL\":\"https://pixabay.com/photos/lotus-flower-lily-pad-pond-1205631/\",\"type\":\"photo\",\"tags\":\"lotus, flower, lily pad\",\"previewURL\":\"https://cdn.pixabay.com/photo/2016/02/17/19/08/lotus-1205631_150.jpg\",\"previewWidth\":150,\"previewHeight\":99,\"webformatURL\":\"https://pixabay.com/get/g80aaa0dd5f3bc0468a5106ce4a256a923e6535aa39eb3699cbcd0edd9d48fbac4d3fcad280875ee9b0c61102837c30e1c95ad41b0d41486003e1559af853b651_640.jpg\",\"webformatWidth\":640,\"webformatHeight\":426,\"largeImageURL\":\"https://pixabay.com/get/g148b0173d84b521630ded801d11d378eb19b55c655417ffd6fb90c66287323644dda95267892a88ca3d88d00adc07831186ebae20c013b643c0bab9f53457c2a_1280.jpg\",\"imageWidth\":5184,\"imageHeight\":3456,\"imageSize\":4776299,\"views\":671798,\"downloads\":346974,\"favorites\":1822,\"collections\":1822,\"likes\":2050,\"comments\":339,\"user_id\":1785462,\"user\":\"Devanath\",\"userImageURL\":\"https://cdn.pixabay.com/user/2016/09/02/10-09-22-263_250x250.png\"},{\"id\":142876,\"pageURL\":\"https://pixabay.com/photos/bouquet-flowers-roses-142876/\",\"type\":\"photo\",\"tags\":\"bouquet, flowers, roses\",\"previewURL\":\"https://cdn.pixabay.com/photo/2013/07/02/22/20/bouquet-142876_150.jpg\",\"previewWidth\":150,\"previewHeight\":112,\"webformatURL\":\"https://pixabay.com/get/gb89f32ae6a283ccc02a5f9f5ab1be31b52930f1106b2c479f6462f44047b6036e4e53517a20edc0368fac444402a67bf_640.jpg\",\"webformatWidth\":640,\"webformatHeight\":480,\"largeImageURL\":\"https://pixabay.com/get/g70aec16e5164ef2decc8a369cf10d8310bb89a3fcf8f90e980f51c843f2719a95a967033d192041db69e08ec1e1548ad57835d501350d1dbf7c7eef311df77c2_1280.jpg\",\"imageWidth\":3500,\"imageHeight\":2626,\"imageSize\":625554,\"views\":1194749,\"downloads\":349266,\"favorites\":1588,\"collections\":1588,\"likes\":1876,\"comments\":431,\"user_id\":5337,\"user\":\"ArtTower\",\"userImageURL\":\"https://cdn.pixabay.com/user/2019/07/27/00-12-46-447_250x250.jpg\"},{\"id\":729509,\"pageURL\":\"https://pixabay.com/photos/rose-flower-love-romance-beautiful-729509/\",\"type\":\"photo\",\"tags\":\"rose, flower, love\",\"previewURL\":\"https://cdn.pixabay.com/photo/2015/04/19/08/32/rose-729509_150.jpg\",\"previewWidth\":150,\"previewHeight\":99,\"webformatURL\":\"https://pixabay.com/get/g391f0f0b516ab412bfda75a9a2367ebcb39f6ae478e7c032d0804ccecbda0e828e844abc29e36b02262d85a600adf231_640.jpg\",\"webformatWidth\":640,\"webformatHeight\":425,\"largeImageURL\":\"https://pixabay.com/get/gfe941505dd1206a3f31d88b8421e02ac5b18a2effacc635cfbef2632e25abe01df5b6ecd92b72b32c67b301a5e62ff710903daa4213f1ebb0fd6b6b5da22d9fe_1280.jpg\",\"imageWidth\":1980,\"imageHeight\":1316,\"imageSize\":500190,\"views\":1076466,\"downloads\":373237,\"favorites\":1852,\"collections\":1852,\"likes\":2130,\"comments\":332,\"user_id\":909086,\"user\":\"Bessi\",\"userImageURL\":\"https://cdn.pixabay.com/user/2019/04/11/22-45-05-994_250x250.jpg\"},{\"id\":729512,\"pageURL\":\"https://pixabay.com/photos/flower-purple-petals-purple-flower-729512/\",\"type\":\"photo\",\"tags\":\"flower, purple, petals\",\"previewURL\":\"https://cdn.pixabay.com/photo/2015/04/19/08/33/flower-729512_150.jpg\",\"previewWidth\":150,\"previewHeight\":99,\"webformatURL\":\"https://pixabay.com/get/g60a4c385e9b683b5f2bfc6803cbd00d3b80b82c66f6cbae5d083b86dc3213272d9a97b9652690be82994c70fc17ef488_640.jpg\",\"webformatWidth\":640,\"webformatHeight\":423,\"largeImageURL\":\"https://pixabay.com/get/g6f636caf7a1bc30f3c35c97e4990e0912a337b83c84c7a37e29e2b7203202e4722b454b2cc02340019041dcf138061df8b09cbd22550e2cfa822df6cee7c90b8_1280.jpg\",\"imageWidth\":1980,\"imageHeight\":1311,\"imageSize\":854653,\"views\":561907,\"downloads\":291044,\"favorites\":1601,\"collections\":1601,\"likes\":1603,\"comments\":242,\"user_id\":909086,\"user\":\"Bessi\",\"userImageURL\":\"https://cdn.pixabay.com/user/2019/04/11/22-45-05-994_250x250.jpg\"},{\"id\":978659,\"pageURL\":\"https://pixabay.com/photos/lotus-flower-bloom-blossom-978659/\",\"type\":\"photo\",\"tags\":\"lotus, flower, bloom\",\"previewURL\":\"https://cdn.pixabay.com/photo/2015/10/09/00/55/lotus-978659_150.jpg\",\"previewWidth\":150,\"previewHeight\":99,\"webformatURL\":\"https://pixabay.com/get/gcd542f46ea7e3bd6693a7b72e5d7ad8ca2d8a2c06cd3bfdf3a0bae59cac63d09ad3a3d1c5147879597fd7ab378a7e969_640.jpg\",\"webformatWidth\":640,\"webformatHeight\":426,\"largeImageURL\":\"https://pixabay.com/get/ge9d4c6ec506d5ea3be4b8d557418d0fd44476f5d1d6113505d1cca2ef1aaf43b2c0fecae65db62a5772c2eec13f1805acba4f0367e7756196ada9c62102568dd_1280.jpg\",\"imageWidth\":3267,\"imageHeight\":2178,\"imageSize\":527232,\"views\":434724,\"downloads\":210708,\"favorites\":1489,\"collections\":1489,\"likes\":1493,\"comments\":208,\"user_id\":1497331,\"user\":\"jennyzhh2008\",\"userImageURL\":\"https://cdn.pixabay.com/user/2015/10/08/23-45-39-663_250x250.jpg\"},{\"id\":3784022,\"pageURL\":\"https://pixabay.com/photos/water-lily-aquatic-plant-flower-3784022/\",\"type\":\"photo\",\"tags\":\"water lily, aquatic plant, flower\",\"previewURL\":\"https://cdn.pixabay.com/photo/2018/10/30/16/06/water-lily-3784022_150.jpg\",\"previewWidth\":150,\"previewHeight\":101,\"webformatURL\":\"https://pixabay.com/get/g24f84a8aa531b134507809dcdfd28c5dd58b872bf4d3144ef76d38adc921b440b6873b73e56deadef6a118d81c0bac1da6ee76446508f0710a8050b948240ce8_640.jpg\",\"webformatWidth\":640,\"webformatHeight\":435,\"largeImageURL\":\"https://pixabay.com/get/g1289f599d3088108d40462bcbe397ad13019aa06541abf3fa614a5a7f73af35f8550b4edc389c4b81bea3d95624897571deda47cad26934198a7fec5282092ae_1280.jpg\",\"imageWidth\":4573,\"imageHeight\":3114,\"imageSize\":2422482,\"views\":863020,\"downloads\":558582,\"favorites\":1235,\"collections\":1235,\"likes\":1507,\"comments\":258,\"user_id\":1195798,\"user\":\"Couleur\",\"userImageURL\":\"https://cdn.pixabay.com/user/2021/06/26/17-56-18-432_250x250.jpg\"},{\"id\":100263,\"pageURL\":\"https://pixabay.com/photos/flower-poppy-field-red-flower-100263/\",\"type\":\"photo\",\"tags\":\"flower, poppy, field\",\"previewURL\":\"https://cdn.pixabay.com/photo/2013/04/03/21/25/flower-100263_150.jpg\",\"previewWidth\":150,\"previewHeight\":93,\"webformatURL\":\"https://pixabay.com/get/g2d6232298862a502b5e4d8f756ccf0348176f7bc2b7ea88bc15cf57ad23eaa96de521dc13f44b3c4de235a2fd60d73f4_640.jpg\",\"webformatWidth\":640,\"webformatHeight\":398,\"largeImageURL\":\"https://pixabay.com/get/ge01d60299de64bd69038a1c3dcad8943174158ba5460638000af12011219d7abd8beff650c4d95cbc5656656d701a1098661d84d1be31bd1a972cd3f530553df_1280.jpg\",\"imageWidth\":3774,\"imageHeight\":2350,\"imageSize\":1175477,\"views\":436564,\"downloads\":184026,\"favorites\":1242,\"collections\":1242,\"likes\":1523,\"comments\":267,\"user_id\":23566,\"user\":\"realworkhard\",\"userImageURL\":\"https://cdn.pixabay.com/user/2013/10/03/21-10-36-920_250x250.jpg\"},{\"id\":3063284,\"pageURL\":\"https://pixabay.com/photos/rose-flower-petal-floral-noble-3063284/\",\"type\":\"photo\",\"tags\":\"rose, flower, petal\",\"previewURL\":\"https://cdn.pixabay.com/photo/2018/01/05/16/24/rose-3063284_150.jpg\",\"previewWidth\":150,\"previewHeight\":99,\"webformatURL\":\"https://pixabay.com/get/g58375f9243310494b348c4ea0d988ba4da917217aec50e44aa9d373737acd465dc1045ec7ec781b6e4203940ecce717bdfb1e779b035918cbdeb7550c1f23633_640.jpg\",\"webformatWidth\":640,\"webformatHeight\":426,\"largeImageURL\":\"https://pixabay.com/get/g4db91180afa78baf4b4cefa8719d084103f91e0a5e9555ba6437458ccbcd92fd484c2e73d907fac92db441aeda55ac9de65e069124261ec52dfb27fc979afe26_1280.jpg\",\"imageWidth\":6000,\"imageHeight\":4000,\"imageSize\":3574625,\"views\":885609,\"downloads\":567367,\"favorites\":1184,\"collections\":1184,\"likes\":1345,\"comments\":292,\"user_id\":1564471,\"user\":\"anncapictures\",\"userImageURL\":\"https://cdn.pixabay.com/user/2015/11/27/06-58-54-609_250x250.jpg\"},{\"id\":19830,\"pageURL\":\"https://pixabay.com/photos/garden-flowers-butterfly-19830/\",\"type\":\"photo\",\"tags\":\"garden, flowers, butterfly\",\"previewURL\":\"https://cdn.pixabay.com/photo/2012/03/01/00/55/garden-19830_150.jpg\",\"previewWidth\":150,\"previewHeight\":99,\"webformatURL\":\"https://pixabay.com/get/g7174f29b85cdfc6bc15690cd02ef94100b369a25540a0e2f99fa11eeaff84eac05d20da4ff29d68d79a36f7c4678ff7f_640.jpg\",\"webformatWidth\":640,\"webformatHeight\":425,\"largeImageURL\":\"https://pixabay.com/get/g32a8aeb74b2a40873a17507077579f0f1c8706b94b452f834dcdb50b75ce84603cab094e67b1339b6f3a162baafae274_1280.jpg\",\"imageWidth\":2144,\"imageHeight\":1424,\"imageSize\":668020,\"views\":1406910,\"downloads\":327861,\"favorites\":2416,\"collections\":2416,\"likes\":3169,\"comments\":561,\"user_id\":1107275,\"user\":\"Larisa-K\",\"userImageURL\":\"https://cdn.pixabay.com/user/2015/06/13/06-38-56-116_250x250.jpg\"},{\"id\":276014,\"pageURL\":\"https://pixabay.com/photos/tree-flowers-meadow-tree-trunk-276014/\",\"type\":\"photo\",\"tags\":\"tree, flowers, meadow\",\"previewURL\":\"https://cdn.pixabay.com/photo/2014/02/27/16/10/tree-276014_150.jpg\",\"previewWidth\":150,\"previewHeight\":95,\"webformatURL\":\"https://pixabay.com/get/ge4cfcd2c9e38be62066b38afd02d04a7799fb5dd8262cf64a4e46cc0c8074c0a43d3834cae25b88234f118dbdc2efb1f_640.jpg\",\"webformatWidth\":640,\"webformatHeight\":407,\"largeImageURL\":\"https://pixabay.com/get/gbb950b2d86b313b4053d41c6a58e56ee176032883b475ec13be93c515be244737b7a61f7b00e79cdf589c9a82ebf72b0da5cfbf7972c363f5a5b3e52c94fd035_1280.jpg\",\"imageWidth\":4090,\"imageHeight\":2602,\"imageSize\":2134495,\"views\":1944671,\"downloads\":714515,\"favorites\":3343,\"collections\":3343,\"likes\":4356,\"comments\":1163,\"user_id\":1107275,\"user\":\"Larisa-K\",\"userImageURL\":\"https://cdn.pixabay.com/user/2015/06/13/06-38-56-116_250x250.jpg\"},{\"id\":1510707,\"pageURL\":\"https://pixabay.com/photos/water-lily-aquatic-plant-flower-1510707/\",\"type\":\"photo\",\"tags\":\"water lily, aquatic plant, flower\",\"previewURL\":\"https://cdn.pixabay.com/photo/2016/07/11/21/23/water-lily-1510707_150.jpg\",\"previewWidth\":150,\"previewHeight\":99,\"webformatURL\":\"https://pixabay.com/get/gf27d8e721044f0135f116f53e5da67cc7c26a8a82d190799b9c0660ccc7eac1539919b7eb97129a9e6ea6053c7116c5c5996f9c6f538b87a5e3ac7705ea1ea0a_640.jpg\",\"webformatWidth\":640,\"webformatHeight\":426,\"largeImageURL\":\"https://pixabay.com/get/g5ae4df3f98b618e7d262d850121de55c145a2a1138b50221aad7ac27f88dac4a7646bf0964af3ab73630620a179b95928ca8248ff8bafeff344ca5e381828380_1280.jpg\",\"imageWidth\":5184,\"imageHeight\":3456,\"imageSize\":1948766,\"views\":365558,\"downloads\":201239,\"favorites\":1180,\"collections\":1180,\"likes\":1129,\"comments\":117,\"user_id\":2364555,\"user\":\"pixel2013\",\"userImageURL\":\"https://cdn.pixabay.com/user/2020/07/25/21-10-11-80_250x250.jpg\"},{\"id\":320868,\"pageURL\":\"https://pixabay.com/photos/rose-flower-petals-red-rose-320868/\",\"type\":\"photo\",\"tags\":\"rose, flower, petals\",\"previewURL\":\"https://cdn.pixabay.com/photo/2014/04/10/11/24/rose-320868_150.jpg\",\"previewWidth\":150,\"previewHeight\":116,\"webformatURL\":\"https://pixabay.com/get/gceb3162dcd115be570cf69bc2b78baa3b60b9d697e969ad8b6c8fcd406d4c6ee9680c4f81c6464c910d1767e251f46b5_640.jpg\",\"webformatWidth\":640,\"webformatHeight\":495,\"largeImageURL\":\"https://pixabay.com/get/gad9faff1028511a59b98fdd66f5b4173e9488c852b8b2b2c7d22b92133bdebdd882f1a7aa4048e6d1b8252e439fc2b01f97c4ee2471a4be39c905326ab8e6577_1280.jpg\",\"imageWidth\":5168,\"imageHeight\":4000,\"imageSize\":1677648,\"views\":1019772,\"downloads\":193618,\"favorites\":1157,\"collections\":1157,\"likes\":1354,\"comments\":230,\"user_id\":48777,\"user\":\"Josch13\",\"userImageURL\":\"https://cdn.pixabay.com/user/2013/11/05/02-10-23-764_250x250.jpg\"},{\"id\":2336287,\"pageURL\":\"https://pixabay.com/illustrations/flower-petals-spring-floral-2336287/\",\"type\":\"illustration\",\"tags\":\"flower, petals, spring\",\"previewURL\":\"https://cdn.pixabay.com/photo/2017/05/23/05/33/flower-2336287_150.jpg\",\"previewWidth\":150,\"previewHeight\":99,\"webformatURL\":\"https://pixabay.com/get/g43e7933dc15bb2472b8bb58d06938d803a051b3ad95b62387a23cdbd13c94472964d7bffb259efbafb29a56777bfc6511afe49db632fe5b01328b8caaaefd75a_640.jpg\",\"webformatWidth\":640,\"webformatHeight\":426,\"largeImageURL\":\"https://pixabay.com/get/ga169b4a3d286b7678d6bb0acc24c364aacbd1d30e7b1e415f21c2cf7e5272d88e0e3dd5827cf1f0969e8f23f83b1b21fbf25bdcf6ca87be680acc787b15a62a1_1280.jpg\",\"imageWidth\":1920,\"imageHeight\":1280,\"imageSize\":252250,\"views\":235507,\"downloads\":100812,\"favorites\":1157,\"collections\":1157,\"likes\":994,\"comments\":280,\"user_id\":3064916,\"user\":\"Owantana\",\"userImageURL\":\"https://cdn.pixabay.com/user/2020/02/08/10-29-37-22_250x250.jpg\"},{\"id\":250016,\"pageURL\":\"https://pixabay.com/photos/flower-field-flowers-field-trees-250016/\",\"type\":\"photo\",\"tags\":\"flower field, flowers, field\",\"previewURL\":\"https://cdn.pixabay.com/photo/2014/01/22/19/44/flower-field-250016_150.jpg\",\"previewWidth\":150,\"previewHeight\":108,\"webformatURL\":\"https://pixabay.com/get/gb56057b39c94fc92ec6e30c6ac351f4ec7094d48fea3f32e37c5de1e607b93eee1202b37ac3829a445ce2f96bd2989e8_640.jpg\",\"webformatWidth\":640,\"webformatHeight\":463,\"largeImageURL\":\"https://pixabay.com/get/gfbce16837720cfab97bb4520e8322aa88a3ba1e0d66d4bd767e7eecd561027c221605a7df157eeb2db50766a566efe554fd229529f5a46da27f756a03071f553_1280.jpg\",\"imageWidth\":4984,\"imageHeight\":3607,\"imageSize\":6895586,\"views\":502375,\"downloads\":191941,\"favorites\":983,\"collections\":983,\"likes\":1466,\"comments\":332,\"user_id\":37465,\"user\":\"DeltaWorks\",\"userImageURL\":\"https://cdn.pixabay.com/user/2013/05/31/16-10-34-727_250x250.png\"},{\"id\":3876195,\"pageURL\":\"https://pixabay.com/photos/flower-branch-twig-autumn-color-3876195/\",\"type\":\"photo\",\"tags\":\"flower, branch, twig\",\"previewURL\":\"https://cdn.pixabay.com/photo/2018/12/15/02/53/flower-3876195_150.jpg\",\"previewWidth\":150,\"previewHeight\":100,\"webformatURL\":\"https://pixabay.com/get/g7a8ce2f7328c5e99bb78d081ac9d9c489831074cfe110e70a921954e80e589b06328ee5bb6327381c96207f1a7367ca0448c74a58379e699562a6f6f88a7753c_640.jpg\",\"webformatWidth\":640,\"webformatHeight\":427,\"largeImageURL\":\"https://pixabay.com/get/g191f6b3b9eae41915060437adc8b3b1c98f5067e38376bdc5ca3c6ef29604fd53248206725eebc733a93ba6bc9d08eafa766547d06c242d2158bf04d87047df1_1280.jpg\",\"imageWidth\":4900,\"imageHeight\":3271,\"imageSize\":2604062,\"views\":409495,\"downloads\":305419,\"favorites\":934,\"collections\":934,\"likes\":1064,\"comments\":207,\"user_id\":1377835,\"user\":\"MabelAmber\",\"userImageURL\":\"https://cdn.pixabay.com/user/2021/06/09/08-47-38-26_250x250.jpg\"}]}"
    mockWebServer.enqueue(MockResponse().setBody(mockResponseBody).setResponseCode(200))

    val imageService = retrofit.create(ImageService::class.java)
    val observer = imageService.searchImages(query = "flower", page = "1")
       .subscribeOn(scheduler)
       .blockingGet()

    Assertions.assertFalse(RetrofitUtil.hasError(observer)) { "Response Has Error" }
    Assertions.assertEquals(observer.response()?.body()?.total, 218948) { "Total is Not correct" }
    Assertions.assertTrue(observer.response()?.body()?.hits?.count() ?: 0 > 0)
  }

  @Test
  fun search_unAvailableImage_returnEmpty() {
    val mockResponseBody = "{\"total\":0,\"totalHits\":0,\"hits\":[]}"
    mockWebServer.enqueue(MockResponse().setBody(mockResponseBody).setResponseCode(200))

    val imageService = retrofit.create(ImageService::class.java)
    val observer = imageService.searchImages(query = "a wrong query text that could not be found", page = "1")
       .subscribeOn(scheduler)
       .blockingGet()

    Assertions.assertFalse(RetrofitUtil.hasError(observer)) { "Response Has Error" }
    Assertions.assertTrue(observer.response()!!.body()!!.total == 0) { "Total Must be 0" }
    Assertions.assertTrue(observer.response()!!.body()!!.hits.count() == 0) { "Hits Must be an Empty List" }
  }

  @Test
  fun search_returnError400() {
    val mockResponseBody = "[ERROR 400] \"page\" is out of valid range."
    mockWebServer.enqueue(MockResponse().setBody(mockResponseBody).setResponseCode(400))

    val imageService = retrofit.create(ImageService::class.java)
    val observer = imageService.searchImages(query = "flower", page = "1")
       .subscribeOn(scheduler)
       .blockingGet()

    Assertions.assertTrue(RetrofitUtil.hasError(observer)) { "Response MUST have error 400, but it does not." }
  }


  @AfterAll
  fun afterAll() {
    mockWebServer.shutdown()
  }
}